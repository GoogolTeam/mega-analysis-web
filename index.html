<!DOCTYPE html>
<html>
<head>
	<title>Mega Analysis</title>
	<script>
	var analyses={TON:{},UNOCF:{}}
	var analysis;
	function elem(id){
		return document.getElementById(id)
	}
	function onload(){
		elem("inputbox").value="0 1 2 w w^2 w^w e0 z0 g0 W W_2 Z".replace(/ /g,"\n")
		elem("nextoutput").onkeypress=nextoutputenter
	}
	async function analyze(){
		analysis=analyses[notation]
		var inputbox=elem("inputbox")
		var outputbox=elem("outputbox")
		var ordinals=inputbox.value.split("\n")
		var output=new Array(ordinals.length)
		var reqordinals=new Array(ordinals.length)
		var skipordinals=[]
		for(var i=0;i<ordinals.length;i++){
			output[i]=format(ordinals[i])
			reqordinals[i]=getreqordinals(ordinals[i])
		}
		for(var i=0;i<reqordinals.length;){
			outputbox.value=output.join("\n")
			var nextordinal=0;
			for(var j=0;j<reqordinals[i].length;j++){
				if(!skipordinals.includes(reqordinals[i][j])){
					nextordinal=reqordinals[i][j]
					break
				}
			}
			if(!nextordinal){
				i++
				if(i==reqordinals.length){
					break
				}
			}else{
				elem("analysis").style.display=""
				var newordinal=await analyzeordinal(nextordinal)
				if(newordinal!=""){
					analysis[nextordinal]=parse(newordinal)
				}else{
					skipordinals.push(nextordinal)
				}
			}
			output[i]=format(ordinals[i])
			reqordinals[i]=getreqordinals(ordinals[i])
		}
		/*for(var i=0;i<ordinals.length;i++){
			if(analysis[ordinals[i]]===undefined){
				elem("analysis").style.display=""
				var newordinal=await analyzeordinal(ordinals[i])
				if(newordinal!=""){
					analysis[ordinals[i]]=parse(newordinal)
				}
			}
			output+=format(ordinals[i])+"\n"
		}*/
		elem("analysis").style.display="none"
		outputbox.value=output.join("\n")
	}
	var savedresolve;
	async function analyzeordinal(ordinal){
		var nextinput=elem("nextinput")
		var nextoutput=elem("nextoutput")
		nextinput.textContent=ordinal
		nextoutput.focus()
		var promise=new Promise((resolve,reject)=>{
			savedresolve=resolve
		})
		return promise
	}
	function nextoutputenter(e){
		if(e.keyCode==13){
			value=e.srcElement.value
			e.srcElement.value=""
			savedresolve(value)
		}
	}
	function save(notation){
		localStorage.setItem(notation,JSON.stringify(analyses[notation]))
	}
	function saveall(){
		var notations=["TON","UNOCF"]
		for(var i=0;i<notations.length;i++){
			save(notations[i])
		}
	}
	function save2(notation){
		elem("exportbox").value=JSON.stringify(analyses[notation])
	}
	function saveall2(notation){
		elem("exportbox").value=JSON.stringify(analyses)
	}
	function load(notation){
		analyses[notation].assign(localStorage.getItem(notation))
	}
	function loadall(){
		var notations=["TON","UNOCF"]
		for(var i=0;i<notations.length;i++){
			load(notations[i])
		}
	}
	function load2(notation){
		Object.assign(analyses[notation],JSON.parse(elem("exportbox").value))
	}
	function loadall2(){
		var newanalysis=JSON.parse(elem("exportbox").value)
		var notations=["TON","UNOCF"]
		for(var i=0;i<notations.length;i++){
			Object.assign(analyses[notation],newanalysis[notations[i]])
		}
	}
	var notations=["UNOCF","TON"]
	var notationid=0
	var notation="UNOCF"
	var formats={"UNOCF":["depth1","depthmax"],"TON":["depth1","depthmax"]}
	var formatids={"UNOCF":1,"TON":1}
	var formatid="depthmax"
	function nextnotation(){
		notationid++
		notationid%=notations.length
		notation=notations[notationid]
		formatid=formats[notation][formatids[notation]]
	}
	function nextformat(){
		formatids[notation]++
		formatids[notation]%=formats[notation].length
		formatid=formats[notation][formatids[notation]]
	}
	function parse(value){
		if(notation=="TON"){
			return value.split(" ")
		}else if(notation=="UNOCF"){
			if(value.match(/ p /)){
				return {type:"psi",terms:value.split(" p ")}
			}else if(value.match(/ \+ /)){
				return {type:"sum",terms:value.split(" + ")}
			}
		}
	}
	function getreqordinals(ordinal){
		if(notation=="TON"){
			var baseordinals=["0","Z"]
			if(formatid=="depth1"){
				if(baseordinals.includes(ordinal)){
					return []
				}else if(analysis[ordinal]!==undefined){
					return []
				}else{
					return [ordinal]
				}
			}else if(formatid=="depthmax"){
				//depth max
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return []
				}else if(value===undefined){
					return [ordinal]
				}else if(value.length==1){
					return []
				}else{
					return getreqordinals(value[0]).concat(getreqordinals(value[1]))
				}
			}
		}else if(notation=="UNOCF"){
			var baseordinals=["0","I"]
			if(formatid=="depth1"){
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return []
				}else if(value===undefined){
					return [ordinal]
				}else if(value.type=="psi"||value.type=="sum"){
					return value.terms.filter(a=>analysis[a]===undefined)
				}
			}else if(formatid=="depthmax"){
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return []
				}else if(value===undefined){
					return [ordinal]
				}else if(value.type=="psi"){
					return getreqordinals(value.terms[0]).concat(getreqordinals(value.terms[1]))
				}else if(value.type=="sum"){
					var ret=[]
					for(var i=0;i<value.terms.length;i++){
						ret=ret.concat(getreqordinals(value.terms[i]))
					}
					return ret
				}
			}
		}
	}
	function format(ordinal){
		if(notation=="TON"){
			var baseordinals=["0","Z"]
			if(formatid=="depth1"){
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return ordinal
				}else if(value===undefined){
					return "?"
				}else if(value.length==1){
					return value
				}else{
					return "C("+value[0]+","+value[1]+")"
				}
			}else if(formatid=="depthmax"){
				//depth max
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return ordinal
				}else if(value===undefined){
					return "?"
				}else if(value.length==1){
					return value
				}else{
					return "C("+format(value[0])+","+format(value[1])+")"
				}
			}
		}else if(notation=="UNOCF"){
			var baseordinals=["0","I"]
			if(formatid=="depth1"){
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return ordinal
				}else if(value===undefined){
					return "?"
				}else if(value.type=="psi"){
					return "psi_{"+value.terms[0]+"}("+value.terms[1]+")"
				}else if(value.type=="sum"){
					return value.terms.join("+")
				}
			}else if(formatid=="depthmax"){
				var value=analysis[ordinal]
				if(baseordinals.includes(ordinal)){
					return ordinal
				}else if(value===undefined){
					return "?"
				}else if(value.type=="psi"){
					return "psi_{"+format(value.terms[0])+"}("+format(value.terms[1])+")"
				}else if(value.type=="sum"){
					return value.terms.map(format).join("+")
				}
			}
		}
	}
	</script>
	<style>
	.analysisbox{
		width:200px;
		height:300px;
	}
	</style>
</head>
<body onload="onload()">
	<textarea id="inputbox" class="analysisbox"></textarea>
	<textarea id="outputbox" class="analysisbox"></textarea>
	<button onclick="analyze()">Analyze!</button>
	<div id="analysis" style="display: none">
		<text id="nextinput"></text>
		<br>
		<input id="nextoutput"></input>
	</div>
	<br>
	<button onclick="nextnotation()">Change notation</button>
	<button onclick="nextformat()">Change output format</button>
	<br>
	<button onclick="save(notation)">Save analysis for current notation</button>
	<button onclick="saveall()">Save analysis for all notations</button>
	<button onclick="save2(notation)">Export analysis for current notation</button>
	<button onclick="saveall2()">Export analysis for all notations</button>
	<br>
	<button onclick="load(notation)">Load analysis for current notation</button>
	<button onclick="loadall()">Load analysis for all notations</button>
	<button onclick="load2(notation)">Import analysis for current notation</button>
	<button onclick="loadall2()">Import analysis for all notations</button>
	<textarea id="exportbox"></textarea>
</body>
</html>